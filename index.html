<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cotizador de Monturas</title>
  <meta name="description" content="Cotizador de monturas ecuestres con extras. Descarga tu cotización en PDF o PNG y compártela por WhatsApp." />
  <style>
    :root {
      --primary: #c2410c;
      --secondary: #f97316;
      --accent: #eab308;
      --bg: #fff7ed;
      --text: #1f2937;
      --muted: #6b7280;
      --card: #fffcf7;
      --border: #eab30833;
      --danger: #dc2626;
      --shadow: 0 4px 32px 0 rgba(234, 88, 12, 0.12);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      background: linear-gradient(180deg, #fff7ed 0%, #f9fafb 90%);
      color: var(--text); min-height: 100vh;
      display: flex; flex-direction: column;
      transition: background .2s;
    }
    .container { max-width: 1000px; margin: 0 auto; padding: 0 16px; width: 100%; }
    .site-header {
      background: linear-gradient(90deg, var(--primary), var(--secondary)); color: #fff; padding: 18px 0 10px; margin-bottom: 20px;
      box-shadow: 0 4px 20px 0 #eab30855;
      position: sticky; top: 0; z-index: 20;
      animation: headerFadeIn .9s cubic-bezier(.9,.12,.23,1.22);
    }
    @keyframes headerFadeIn { from { opacity: 0; transform: translateY(-30px);} to { opacity: 1; transform: none;}}
    .site-header .brand {
      font-size: 1.4rem; font-weight: 900; display: flex; align-items: center; gap: 14px;
      letter-spacing: .3px;
    }
    .site-header .brand .logo {
      background: linear-gradient(135deg, #fff, #ffecc4); color: var(--primary);
      width: 44px; height: 44px; display: grid; place-items: center;
      border-radius: 12px; font-size: 1.25em; font-weight: 900;
      box-shadow: 0 3px 12px #eab30844, 0 1px 5px #fff4;
      border: 2px solid var(--accent);
      transition: box-shadow .18s;
    }
    .site-header .brand .logo:hover { box-shadow: 0 0 0 5px #eab30833, 0 3px 12px #eab30855;}
    .site-header nav a {
      color: #fff; text-decoration: none; margin-left: 18px; font-weight: 600;
      border-bottom: 2px solid transparent; padding-bottom: 3px;
      opacity: .94; transition: all 160ms;
      letter-spacing: .2px;
    }
    .site-header nav a:hover {
      opacity: 1; border-color: var(--accent); color: #fef9c3;
      filter: drop-shadow(0 0 6px #ffe06677);
    }
    main { flex: 1 0 auto; }
    .card {
      background: var(--card); border: 1.5px solid var(--border); border-radius: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 24px; padding: 26px 22px 22px 22px;
      animation: cardIn .5s cubic-bezier(.7,-0.08,.28,1.09);
      position: relative;
      overflow: hidden;
      transition: box-shadow .18s, border-color .18s;
    }
    @keyframes cardIn { 0% {opacity:0;transform:translateY(32px) scale(.99);} 100% {opacity:1;transform:none;} }
    .card-header {
      font-size: 1.22rem; font-weight: 800; margin-bottom: 18px; letter-spacing: .1px;
      color: var(--primary);
      text-shadow: 0 1px 0 #fff, 0 2px 6px #ffecc47a;
      display: flex; align-items: center; gap: 10px;
    }
    .field { margin-bottom: 16px; position: relative; }
    .field label { font-weight: 700; display: block; margin-bottom: 7px; }
    .row { display: flex; gap: 14px; }
    .subgroup {
      background: linear-gradient(90deg, #fffbe5 0%, #fff9e6 100%);
      border: 1px dashed var(--border); border-radius: 13px; padding: 12px;
      box-shadow: 0 1px 8px #ffecc44a;
    }
    select, input[type="number"], input[type="text"] {
      padding: 10px 12px; border: 1.2px solid var(--border); border-radius: 9px; font-size: 1.04rem; width: 100%;
      margin-bottom: 4px; background: #fffbeed9; color: var(--text);
      transition: border-color .2s, box-shadow .18s;
      box-shadow: 0 1px 5px #ffecc432;
    }
    select:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px #ffe06644; outline: none;}
    input[type="checkbox"], input[type="radio"] {
      accent-color: var(--primary);
      transform: scale(1.16);
      margin-right: 6px;
      transition: accent-color .2s;
    }
    input[type="checkbox"]:focus, input[type="radio"]:focus { outline: 2px solid var(--accent);}
    .actions {
      display: flex; gap: 11px; flex-wrap: wrap; margin-top: 20px;
      align-items: center; justify-content: flex-end;
    }
    .btn, .btn-outline {
      border-radius: 12px; padding: 13px 22px; font-weight: 800; cursor: pointer;
      font-size: 1.01rem; letter-spacing: .05em;
      box-shadow: 0 2px 8px #eab3081a, 0 1.5px 8px #fff4;
      position: relative; overflow: hidden; isolation: isolate;
      transition: transform .15s, box-shadow .15s, background .16s;
    }
    .btn {
      color: #0b1020;
      background: linear-gradient(90deg, #fef9c3, var(--accent), #ffedd5);
      background-size: 200% 200%;
      animation: gradientShift 6s ease infinite;
      border: none;
      outline: 2px solid var(--accent);
      outline-offset: -2px;
      box-shadow: 0 6px 18px #eab30842, 0 1px 5px #fff4;
    }
    .btn-outline {
      background: #fff;
      border: 1.2px solid var(--border);
      color: var(--primary);
      box-shadow: 0 2px 10px #f59e0b14, 0 1px 5px #fff4;
    }
    .btn:active, .btn-outline:active, .btn:focus, .btn-outline:focus {
      transform: scale(.96);
      filter: brightness(.97);
    }
    .btn:hover, .btn-outline:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 10px 28px #fde68a92, 0 0 0 7px #fffbe3;
      filter: brightness(1.02);
    }
    @keyframes gradientShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%}}
    .btn .ripple, .btn-outline .ripple {
      position: absolute; pointer-events: none; border-radius: 9999px;
      transform: scale(0); background: rgba(255,255,255,.55);
      animation: ripple 560ms ease;
      mix-blend-mode: screen;
      z-index: 10;
    }
    @keyframes ripple {to {transform:scale(4);opacity:0;}}
    .total {
      font-size: 2.2rem; font-weight: 900; color: var(--primary); margin: 10px 0 6px;
      letter-spacing: .03em; text-shadow: 0 2px 0 #fff, 0 2px 6px #ffecc47a;
      animation: fadeInTotal .4s cubic-bezier(.7,-.06,.22,1.09);
    }
    @keyframes fadeInTotal {0%{opacity:0;transform:scale(.91);}100%{opacity:1;transform:none;}}
    .error {
      color: var(--danger); font-size: .98rem;
      background: #fee2e2bb; border: 1px solid #fecaca;
      border-radius: 8px; padding: 8px 14px; margin: 10px 0 0; display: none;
      box-shadow: 0 2px 14px #ef44440d;
      animation: fadeInError .4s cubic-bezier(.7,-.06,.22,1.09);
    }
    @keyframes fadeInError {0%{opacity:0;transform:scale(.97);}100%{opacity:1;transform:none;}}
    @media (max-width: 740px) { .row { flex-direction: column; } }
    .site-footer {
      background: #0b1020; color: #ffc66d;
      padding: 20px 0; text-align: center; margin-top: 0;
      box-shadow: 0 -3px 12px #ffecc422;
      border-top: 3.5px solid var(--accent);
    }
    .site-footer a { color: #e2e8f0;}
    .hint {
      color: var(--muted); font-size: .96rem; font-weight: 500;
      letter-spacing: .05em;
    }
    ul.breakdown { list-style: none; padding: 0; margin: 6px 0 0; }
    ul.breakdown li {
      display: flex; align-items: center; justify-content: space-between; padding: 7px 0;
      border-bottom: 1px dashed var(--border); gap: 8px;
      transition: background .14s;
    }
    ul.breakdown li:last-child { border-bottom: 0; }
    #cotizacionResumen {
      border: 2px solid var(--border);
      border-radius: 15px;
      background:
        radial-gradient(1200px 1200px at 100% -10%, rgba(234,88,12,.06), transparent 70%),
        radial-gradient(1200px 1200px at -10% 100%, rgba(234,88,12,.06), transparent 70%),
        #fffbeed9;
      box-shadow: 0 10px 30px rgba(2,6,23,0.06), inset 0 0 0 1px rgba(255,255,255,.6);
      margin-bottom: 10px;
      padding: 18px 18px 14px;
      animation: fadeInSummary .5s cubic-bezier(.85,-.08,.22,1.09);
    }
    @keyframes fadeInSummary {0%{opacity:0;transform:translateY(16px) scale(.97);}100%{opacity:1;transform:none;}}
    .quote-meta {
      text-align: right;
      font-size: .95rem;
      color: var(--muted);
      margin-bottom: 8px;
      letter-spacing: .04em;
    }
    .quote-title {
      font-size: 1.12rem; font-weight: 800; margin: 0 0 2px 0; color: var(--primary);
      text-shadow: 0 1px 0 #fff, 0 2px 6px #ffecc47a;
    }
    .quote-footer {
      margin-top: 10px; font-size: .95rem; color: var(--muted);
      display: flex; justify-content: space-between; align-items: center;
    }
    .quote-badge {
      width: 42px; height: 42px; border-radius: 12px;
      background: linear-gradient(135deg, #fff, #ffecc4); color: var(--primary);
      display: grid; place-items: center; font-weight: 900; font-size: 1.3em;
      box-shadow: 0 2px 8px #ffecc455, 0 1px 5px #fff4;
      border: 2px solid var(--accent);
      margin-right: 7px;
    }
    .divider { height: 1.2px; background: var(--border); margin: 12px 0 14px 0; border-radius: 2.4px;}
  </style>
  <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;700;900&display=swap" rel="stylesheet" />
</head>
<body>
  <header class="site-header">
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;">
      <div class="brand"><span class="logo">CM</span> Cotizador de Monturas</div>
      <nav>
        <a href="#montura">Montura</a>
        <a href="#extras">Extras</a>
        <a href="#total">Total</a>
        <a href="misionyvision.html">Misión y Visión</a>
        <a href="redes.html">Redes</a>
      </nav>
    </div>
  </header>
  <main class="container">
    <form id="cotizadorForm" autocomplete="off">
      <div class="card" id="montura">
        <div class="card-header">Montura</div>
        <div class="field">
          <label for="fusteEstilo">Fuste - Estilo</label>
          <select id="fusteEstilo" name="fusteEstilo">
            <option value="saldivar">Saldívar</option>
            <option value="buchon">Buchón</option>
          </select>
        </div>
        <div class="field">
          <label for="medidaFuste">Fuste - Medida <span class="hint">(en pulgadas, ej: 14, 14.5, 15...)</span></label>
          <select id="medidaFuste" name="medidaFuste">
            <option value="13.5">-14</option>
            <option value="14">14</option>
            <option value="14.5">14.5</option>
            <option value="15">15</option>
            <option value="15.5">15.5</option>
            <option value="16">16</option>
            <option value="16.5">16.5</option>
            <option value="17">17</option>
            <option value="18">18</option>
          </select>
          <div id="medidaError" class="error"></div>
        </div>
        <div class="field">
          <label><input type="checkbox" id="clienteMandaFuste" name="clienteMandaFuste" /> El cliente envía su fuste <span class="hint">(-$1,000)</span></label>
        </div>
        <div class="field">
          <label for="cueraje">Cueraje</label>
          <select id="cueraje" name="cueraje">
            <option value="cantinas_redondas_basto_mediano">Cantinas redondas basto mediano</option>
            <option value="cantinas_cuadradas_basto_mediano">Cantinas cuadradas basto mediano</option>
            <option value="cantinas_redondas_basto_grande">Cantinas redondas basto grande</option>
            <option value="cantinas_cuadradas_basto_grande">Cantinas cuadradas basto grande</option>
            <option value="esqueleto_basto_cuadrado">Esqueleto basto cuadrado</option>
            <option value="esqueleto_cola_pato">Esqueleto cola de pato</option>
          </select>
        </div>
        <div class="field">
          <label>Arciones</label>
          <div class="row">
            <div>
              <label class="hint">Estilo</label>
              <label><input type="radio" name="arcEstilo" value="sencilla" checked /> Sencillas</label>
              <label><input type="radio" name="arcEstilo" value="doble" /> Dobles</label>
            </div>
            <div>
              <label class="hint">Tipo</label>
              <label><input type="radio" name="arcTipo" value="recta" checked /> Rectas</label>
              <label><input type="radio" name="arcTipo" value="sudadera" /> Sudadera</label>
            </div>
          </div>
          <div class="hint" id="arcTipoHint"></div>
        </div>
        <div class="field">
          <label for="herrajeEstilo">Herraje - Estilo</label>
          <select id="herrajeEstilo" name="herrajeEstilo">
            <option value="cuero">Cuero</option>
            <option value="cuerno_toro">Cuerno de toro (+$3,000)</option>
            <option value="inox_blanco">Acero inoxidable blanco (+$3,500)</option>
            <option value="inox_pavonado">Acero inoxidable pavonado (+$4,500)</option>
            <option value="fierro_aluminio">Fierro incrustado de aluminio (+$9,000)</option>
            <option value="fierro_plata">Fierro incrustado de plata (trabajo especial)</option>
          </select>
        </div>
        <div class="field">
          <label for="herrajeGreca">Herraje - Greca</label>
          <select id="herrajeGreca" name="herrajeGreca">
            <option value="L">L</option>
            <option value="T">T</option>
            <option value="Y">Y</option>
          </select>
        </div>
        <div class="field">
          <label><input type="checkbox" id="argollasTapa" name="argollasTapa" /> Argollas de tapa <span class="hint">(+ $1,000)</span></label>
          <div class="hint" id="argTapaHint"></div>
        </div>
        <div class="field">
          <label>Estribos</label>
          <label><input type="radio" name="estribos" value="abierto" checked /> Abierto (incluidos)</label>
          <label><input type="radio" name="estribos" value="tapadera" /> De tapadera (+$1,500)</label>
        </div>
      </div>
      <div class="card" id="extras">
        <div class="card-header">Extras y Textiles</div>
        <div class="field">
          <label>Carona</label>
          <select id="carona" name="carona">
            <option value="">No agregar</option>
            <option value="cola_pato">Cola de pato (+$800)</option>
            <option value="basto_cuadrado">Basto cuadrado (+$1,000)</option>
            <option value="redondas_basto_mediano">Redondas basto mediano (+$1,200)</option>
            <option value="cuadradas_basto_mediano">Cuadradas basto mediano (+$1,200)</option>
            <option value="redondas_basto_grande">Redondas basto grande (+$1,500)</option>
            <option value="cuadradas_basto_grande">Cuadradas basto grande (+$1,500)</option>
          </select>
        </div>
        <div class="field">
          <label>Zarape</label>
          <label><input type="radio" name="zarape" value="" checked /> Ninguno</label>
          <label><input type="radio" name="zarape" value="sencillo" /> Sencillo (+$900)</label>
          <label><input type="radio" name="zarape" value="fino" /> Fino (+$3,500)</label>
        </div>
        <div class="field">
          <label><input type="checkbox" id="cincha" name="cincha" /> Cincha (+$1,200)</label>
          <input type="number" id="cinchaMedida" name="cinchaMedida" placeholder="Medida en cm" min="30" max="200" style="max-width:140px;" />
        </div>
        <div class="field">
          <label><input type="checkbox" id="cuarta" name="cuarta" /> Cuarta estándar (+$500)</label>
        </div>
        <div class="field">
          <label><input type="checkbox" id="jaquima" name="jaquima" /> Jáquima / Bozalillo fino de faena (+$2,800)</label>
        </div>
        <div class="field">
          <label>Cinturón de piel cosido a mano (2") (+$900)</label>
          <input type="checkbox" id="cinturon" name="cinturon" />
          <input type="text" id="cinturonTalla" name="cinturonTalla" placeholder="Talla de pantalón (ej. 32)" style="max-width:130px;" />
          <div class="hint">No incluye hebilla, se cotiza aparte.</div>
        </div>
        <div class="field">
          <label>Extras que se cotizan por mensaje directo:</label>
          <label><input type="checkbox" id="hebilla" name="hebilla" /> Hebilla del cinturón</label>
          <label><input type="checkbox" id="espuelas" name="espuelas" /> Espuelas</label>
          <label><input type="checkbox" id="machete" name="machete" /> Machete</label>
          <label><input type="checkbox" id="freno" name="freno" /> Freno</label>
          <label><input type="checkbox" id="cuchillo" name="cuchillo" /> Cuchillo</label>
        </div>
      </div>
      <div class="card" id="total">
        <div class="card-header">Total</div>
        <div id="cotizacionResumen">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:5px;">
            <div class="quote-badge">CM</div>
            <div>
              <div class="quote-title">Cotización personalizada</div>
              <div class="hint">Montura + Textiles/Extras</div>
            </div>
            <div style="margin-left:auto;text-align:right;">
              <div class="quote-meta">Fecha: <span id="quoteDate">—</span></div>
              <div class="quote-meta">Moneda: MXN</div>
            </div>
          </div>
          <div class="divider"></div>
          <div>
            <div class="hint" style="font-weight:700;">Precio total</div>
            <div class="total" id="precioTotal">MX$0.00</div>
          </div>
          <div class="divider"></div>
          <div>
            <div class="hint" style="font-weight:700;">Detalle</div>
            <ul class="breakdown" id="detalleLista"></ul>
          </div>
          <div class="divider"></div>
          <div class="quote-footer">
            <span>by: Empresa</span>
            <span>Contacto: WhatsApp +52 722 612 8347</span>
          </div>
        </div>
        <div class="actions">
          <button type="button" class="btn-outline" id="btnPdf">Descargar PDF</button>
          <button type="button" class="btn" id="btnPng">Descargar PNG</button>
          <a class="btn-outline" id="btnWhats" href="#" target="_blank" rel="noopener">Enviar por WhatsApp</a>
        </div>
        <div class="hint" style="margin-top:8px;">Los extras con “trabajo especial” requieren cotización directa con el artesano.</div>
      </div>
    </form>
  </main>
  <footer class="site-footer">
    <div class="container">
      <p>By: JP — Todos los derechos reservados - v1.3</p>
    </div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
    function money(n) { return (n || 0).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' }); }
    let PRECIOS = null;

    const form = document.getElementById('cotizadorForm');
    const medidaFuste = document.getElementById('medidaFuste');
    const medidaError = document.getElementById('medidaError');
    const cueraje = document.getElementById('cueraje');
    const herrajeEstilo = document.getElementById('herrajeEstilo');
    const argollasTapa = document.getElementById('argollasTapa');
    const arcTipoHint = document.getElementById('arcTipoHint');
    const argTapaHint = document.getElementById('argTapaHint');
    const btnWhats = document.getElementById('btnWhats');
    const btnPdf = document.getElementById('btnPdf');
    const btnPng = document.getElementById('btnPng');
    const precioTotalEl = document.getElementById('precioTotal');
    const detalleLista = document.getElementById('detalleLista');
    const quoteDateEl = document.getElementById('quoteDate');
    const cotizacionResumen = document.getElementById('cotizacionResumen');

    function getPreciosJsonUrl() {
      let path = window.location.pathname;
      if (path.endsWith('/')) path += 'index.html';
      let preciosPath = 'precios.json';
      if (path.match(/\/files\//)) preciosPath = 'precios.json';
      return preciosPath + '?ts=' + Date.now();
    }

    async function loadPrices() {
      try {
        if (window.location.protocol === "file:") {
          alert("No puedes usar el cotizador abriendo el HTML directamente. Usa un servidor local HTTP (Live Server, Python, XAMPP, etc).");
          PRECIOS = null;
          return;
        }
        const preciosUrl = getPreciosJsonUrl();
        const res = await fetch(preciosUrl, { cache: 'no-store' });
        if (!res.ok) throw new Error("No se pudo cargar precios.json");
        PRECIOS = await res.json();
      } catch (e) {
        alert("No se pudo cargar precios.json, verifica la ruta, el servidor y que el archivo sea válido.");
        PRECIOS = null;
      } finally {
        calcular();
      }
    }

    function getCuerajePrice(cuerajeVal, herrajeVal) {
      if (!PRECIOS) return { base: 0, delta: 0, especial: false };
      let base = 0;
      let especial = false;
      let cuerajeKey, bastoKey, formaKey;
      if (/cantinas|bastos/.test(cuerajeVal)) {
        let parts = cuerajeVal.split('_');
        cuerajeKey = parts[0];
        formaKey = parts[1];
        bastoKey = parts[3] === "grande" ? "grande" : "mediano";
        base = PRECIOS.cueraje?.[cuerajeKey]?.[bastoKey]?.[formaKey] ?? 0;
      } else if (/esqueleto/.test(cuerajeVal)) {
        if (cuerajeVal === "esqueleto_basto_cuadrado") {
          base = PRECIOS.cueraje?.esqueleto?.basto_cuadrado ?? 0;
        } else if (cuerajeVal === "esqueleto_cola_pato") {
          base = PRECIOS.cueraje?.esqueleto?.cola_pato ?? 0;
        }
      }
      let hmap = {
        "cuero": "cuero",
        "cuerno_toro": "cuerno",
        "inox_blanco": "inox_blanco",
        "inox_pavonado": "inox_pavonado",
        "fierro_aluminio": "fierro_aluminio",
        "fierro_plata": "fierro_plata"
      };
      let herrajeKey = hmap[herrajeVal];
      let delta = PRECIOS.herraje?.estilos?.[herrajeKey];
      if (herrajeVal === "fierro_plata") especial = true;
      if (delta === undefined || delta === null || delta === "pendiente") delta = 0;
      return { base, delta, especial };
    }

    function calcular() {
      if (!PRECIOS) return;
      let items = [];
      let total = 0;
      let trabajoEspecial = false;
      let cotizarDirecto = [];

      const fusteEstilo = form.fusteEstilo.value;
      const medida = form.medidaFuste.value;
      let fusteDesc = `Fuste: ${fusteEstilo === 'saldivar' ? 'Saldívar' : 'Buchón'} - ${medida}"`;
      let fusteError = "";
      if (parseFloat(medida) >= 16.5) {
        fusteError = 'Fustes de 16.5" o más se cotizan aparte por mensaje directo (trabajo especial).';
        trabajoEspecial = true;
      }
      if (parseFloat(medida) < 14) {
        fusteDesc += " (costo incluido)";
      }
      items.push({ text: fusteDesc, price: 0 });
      medidaError.style.display = fusteError ? 'block' : 'none';
      medidaError.textContent = fusteError;

      const cuerajeVal = cueraje.value;
      const cuerajeLabel = cueraje.options[cueraje.selectedIndex].textContent;
      const herrajeVal = herrajeEstilo.value;
      const { base, delta, especial } = getCuerajePrice(cuerajeVal, herrajeVal);
      let herrajeGreca = form.herrajeGreca.value;
      let argTapaDisp = ["inox_blanco", "inox_pavonado", "fierro_aluminio", "fierro_plata"].includes(herrajeVal);
      let argTapa = argollasTapa.checked && argTapaDisp;
      let argTapaPrecio = argTapa ? (PRECIOS.herraje?.argollas_tapa ?? 1000) : 0;
      let detalleHerraje = `${cuerajeLabel} con Herraje: ${herrajeEstilo.options ? herrajeEstilo.options[herrajeEstilo.selectedIndex].textContent : herrajeVal} — Greca ${herrajeGreca}`;
      if (argTapa) detalleHerraje += " — Argollas de tapa";
      if (especial) {
        detalleHerraje += " (trabajo especial, cotizar con artesano)";
        items.push({ text: detalleHerraje, price: 0 });
        trabajoEspecial = true;
      } else {
        items.push({ text: detalleHerraje, price: base + delta + argTapaPrecio });
      }
      argollasTapa.disabled = !argTapaDisp;
      argTapaHint.textContent = argTapaDisp ? "" : "Solo disponible con herraje de acero inoxidable, fierro de aluminio o plata.";

      if (form.clienteMandaFuste.checked) {
        items.push({ text: "El cliente envía su fuste", price: - (PRECIOS.fuste?.descuentoClienteManda ?? 1000) });
      }

      let arcEstilo = getSelected("arcEstilo");
      let arcTipo = getSelected("arcTipo");
      let tipoFijo = !["esqueleto_cola_pato", "esqueleto_basto_cuadrado"].includes(cuerajeVal);
      if (tipoFijo) {
        arcTipo = "recta";
        arcTipoHint.textContent = "Solo las monturas esqueleto tienen opción de arción tipo sudadera. Para el resto, solo rectas.";
      } else {
        arcTipoHint.textContent = "";
      }
      let arcDesc = `Arciones: ${arcEstilo === "doble" ? "Dobles" : "Sencillas"} - ${arcTipo === "sudadera" ? "Sudadera" : "Rectas"}`;
      items.push({ text: arcDesc, price: 0 });

      let estribos = getSelected("estribos");
      let estrPrice = estribos === "tapadera" ? (PRECIOS.estribos?.tapadera ?? 1500) : 0;
      let estrDesc = estribos === "tapadera" ? "Estribos de tapadera (+$1,500)" : "Estribos abiertos (incluidos)";
      items.push({ text: estrDesc, price: estrPrice });

      let caronaVal = form.carona.value;
      if (caronaVal && PRECIOS.carona && PRECIOS.carona[caronaVal] !== undefined) {
        let price = PRECIOS.carona[caronaVal];
        items.push({ text: `Carona (${caronaVal.replace(/_/g, ' ')})`, price });
      }
      let zarape = getSelected("zarape");
      if (zarape && zarape !== "" && PRECIOS.zarape && PRECIOS.zarape[zarape] !== undefined) {
        let price = PRECIOS.zarape[zarape];
        items.push({ text: `Zarape ${zarape === "fino" ? "fino" : "sencillo"}`, price });
      }
      if (form.cincha.checked) {
        let medida = form.cinchaMedida.value ? ` (${form.cinchaMedida.value}cm)` : "";
        items.push({ text: "Cincha" + medida, price: PRECIOS.extras?.cincha ?? 1200 });
      }
      if (form.cuarta.checked) items.push({ text: "Cuarta estándar", price: PRECIOS.extras?.cuarta ?? 500 });
      if (form.jaquima.checked) items.push({ text: "Jáquima / Bozalillo", price: PRECIOS.extras?.jaquima ?? 2800 });
      if (form.cinturon.checked) {
        let talla = form.cinturonTalla.value ? ` (talla ${form.cinturonTalla.value})` : "";
        items.push({ text: "Cinturón de piel cosido a mano" + talla, price: PRECIOS.extras?.cinturon ?? 900 });
      }
      [
        {id:"hebilla", label:"Hebilla del cinturón"},
        {id:"espuelas", label:"Espuelas"},
        {id:"machete", label:"Machete"},
        {id:"freno", label:"Freno"},
        {id:"cuchillo", label:"Cuchillo"}
      ].forEach(item => {
        if (form[item.id].checked) {
          items.push({ text: item.label + " (trabajo especial, cotizar con artesano)", price: 0 });
          cotizarDirecto.push(item.label);
        }
      });

      detalleLista.innerHTML = items.map(it => {
        let precioTexto = "";
        if (trabajoEspecial && it.price === 0) precioTexto = "trabajo especial";
        else if (it.price === 0) precioTexto = "Incluido";
        else precioTexto = money(it.price);
        return `<li><span>${it.text}</span><strong>${precioTexto}</strong></li>`;
      }).join("");
      total = items.reduce((s, it) => s + (typeof it.price === "number" ? it.price : 0), 0);
      precioTotalEl.textContent = money(total);

      const phone = '527226128347';
      let resumenTxt = items.map(it => `${it.text}: ${typeof it.price === "number"
        ? (it.price === 0 ? "Incluido" : money(it.price))
        : it.price}`).join('\n');
      let text = encodeURIComponent(
        `Hola, te comparto la cotización:\n\n${resumenTxt}\n\nTotal: ${money(total)}\n\n${cotizarDirecto.length ? 'Requiere cotización directa de: ' + cotizarDirecto.join(', ') : ''}`
      );
      btnWhats.href = `https://wa.me/${phone}?text=${text}`;
    }

    // Ripple efecto botones
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('.btn, .btn-outline');
      if (!btn) return;
      const rect = btn.getBoundingClientRect();
      const d = Math.max(btn.clientWidth, btn.clientHeight);
      const ripple = document.createElement('span');
      ripple.className = 'ripple';
      ripple.style.width = ripple.style.height = d + 'px';
      ripple.style.left = (e.clientX - rect.left - d / 2) + 'px';
      ripple.style.top = (e.clientY - rect.top - d / 2) + 'px';
      const old = btn.querySelector('.ripple');
      if (old) old.remove();
      btn.appendChild(ripple);
    }, { passive: true });

    // Fuerza fondo y color opacos a toda la sección "total" y sus hijos SOLO durante exportación
    function forceExportStyles(el) {
      el.style.background = '#fff';
      el.style.backgroundColor = '#fff';
      el.style.color = '#111';
      el.style.boxShadow = 'none';
      el.style.textShadow = 'none';
      el.style.filter = 'none';
      el.style.fontFamily = "'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial";
      for (const child of el.children) forceExportStyles(child);
    }
    function restoreExportStyles(el, backup) {
      for (const [prop, value] of Object.entries(backup)) {
        if (prop !== "children") el.style[prop] = value;
      }
      if (el.children && backup.children) {
        for (let i = 0; i < el.children.length; i++) {
          restoreExportStyles(el.children[i], backup.children[i]);
        }
      }
    }
    function backupStyles(el) {
      const props = ['background', 'backgroundColor', 'color', 'boxShadow', 'textShadow', 'filter', 'fontFamily'];
      const backup = {};
      for (const p of props) backup[p] = el.style[p];
      backup.children = [];
      for (const child of el.children) {
        backup.children.push(backupStyles(child));
      }
      return backup;
    }

    // PDF
    btnPdf.addEventListener('click', async () => {
      const area = document.getElementById('total');
      const styleBackup = backupStyles(area);
      forceExportStyles(area);
      await new Promise(res => setTimeout(res, 80));
      const canvas = await html2canvas(area, {
        scale: 2,
        backgroundColor: '#fff',
        useCORS: true
      });
      restoreExportStyles(area, styleBackup);
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 10;
      const maxW = pageWidth - margin * 2;
      const maxH = pageHeight - margin * 2;
      const imgWidth = canvas.width;
      const imgHeight = canvas.height;
      const ratio = Math.min(maxW / imgWidth, maxH / imgHeight);
      const pdfW = imgWidth * ratio;
      const pdfH = imgHeight * ratio;
      const x = (pageWidth - pdfW) / 2;
      const y = (pageHeight - pdfH) / 2;
      pdf.addImage(imgData, 'PNG', x, y, pdfW, pdfH);
      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      const stamp = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}`;
      pdf.save(`cotizacion-montura-${stamp}.pdf`);
    });

    // PNG
    btnPng.addEventListener('click', async () => {
      const area = document.getElementById('total');
      const styleBackup = backupStyles(area);
      forceExportStyles(area);
      await new Promise(res => setTimeout(res, 80));
      const canvas = await html2canvas(area, {
        scale: 2,
        backgroundColor: '#fff',
        useCORS: true
      });
      restoreExportStyles(area, styleBackup);
      const dataUrl = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = dataUrl;
      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      const stamp = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}`;
      a.download = `cotizacion-montura-${stamp}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    function setQuoteDate() {
      if (!quoteDateEl) return;
      const now = new Date();
      quoteDateEl.textContent = new Intl.DateTimeFormat('es-MX', { dateStyle: 'medium', timeStyle: 'short' }).format(now);
    }
    setQuoteDate();

    function getSelected(name) {
      const checked = form.querySelector(`[name="${name}"]:checked`);
      return checked ? checked.value : '';
    }

    form.addEventListener('input', calcular);
    form.addEventListener('change', calcular);

    loadPrices();
    setInterval(setQuoteDate, 60000);
</script>
</body>
</html>
